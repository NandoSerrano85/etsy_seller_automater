# Caddyfile for CraftFlow Multi-Tenant Storefront
# This configuration handles:
# - Wildcard subdomain routing (*.craftflow.store -> storefront)
# - Custom domain routing with automatic SSL
# - API routing to backend

# Global options
{
    # Email for Let's Encrypt certificates
    email admin@craftflow.store

    # Enable automatic HTTPS
    auto_https on

    # ACME server (use staging for testing)
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Main CraftFlow Admin Application
admin.craftflow.store {
    reverse_proxy admin-frontend:3000
}

# API Backend
api.craftflow.store {
    reverse_proxy backend:3003 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Wildcard subdomain for tenant storefronts
*.craftflow.store {
    # Extract subdomain from host
    @subdomain {
        expression {http.request.host.labels.2} != "admin" && {http.request.host.labels.2} != "api"
    }

    # Route to storefront application
    handle @subdomain {
        reverse_proxy storefront:3001 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            # Pass the full host for multi-tenant detection
            header_up X-Original-Host {host}
        }
    }
}

# Custom domain handling (catch-all for verified custom domains)
# These domains should be added dynamically or via environment variables
# For production, consider using Caddy's on-demand TLS feature

# On-demand TLS for custom domains
# Uncomment and configure for production:
# {
#     on_demand_tls {
#         ask http://backend:3003/api/internal/verify-domain
#         interval 2m
#         burst 5
#     }
# }

# Catch-all for custom domains
:443 {
    tls {
        on_demand
    }

    reverse_proxy storefront:3001 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Original-Host {host}
    }
}

# HTTP to HTTPS redirect
:80 {
    redir https://{host}{uri} permanent
}
